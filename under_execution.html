<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø±ÙˆÙŠØ§Ù„ Ø¬Ø§Ø² - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --excel-green: #217346; --ui-gray: #f3f2f1; --border: #d1d1d1; --accent: #0078d4; --select-bg: #cde2ff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #eee; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ */
        #lockScreen { position: fixed; inset: 0; background: #1a252f; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .lock-box { background: white; padding: 40px; border-radius: 15px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .lock-box input { padding: 10px; width: 150px; text-align: center; font-size: 20px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 20px; display: block; margin-inline: auto; }
        .unlock-btn { background: var(--excel-green); color: white; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        #mainContainer { visibility: hidden; display: flex; flex-direction: column; height: 100vh; }

        .setup-bar { background: #1e1e1e; color: #ddd; padding: 8px 15px; display: flex; gap: 15px; align-items: center; font-size: 12px; }
        .setup-bar input { background: #333; border: 1px solid #555; color: white; padding: 4px; border-radius: 3px; width: 180px; }

        .ribbon { background: var(--ui-gray); padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap; }
        
        .grid-container { flex-grow: 1; overflow: auto; background: #fff; margin: 5px; border: 1px solid #999; }
        table { border-collapse: collapse; table-layout: fixed; min-width: max-content; }
        
        thead th { position: sticky; top: 0; background: #e6e6e6; z-index: 20; border: 1px solid #bbb; height: 35px; font-size: 13px; min-width: 150px; cursor: pointer; }
        thead th.selected-head { background: #b0d4ff; border: 1px solid var(--accent); }

        .row-header { position: sticky; right: 0; background: #e6e6e6; z-index: 15; width: 45px; text-align: center; border: 1px solid #bbb; font-weight: bold; cursor: pointer; }
        .row-header.selected-head { background: #b0d4ff; border: 1px solid var(--accent); }

        td { border: 1px solid #ccc; padding: 0; height: 30px; }
        .selected-row td { background-color: var(--select-bg); }
        .selected-col { background-color: var(--select-bg) !important; }

        .cell-input { width: 100%; height: 100%; border: none; outline: none; padding: 0 8px; text-align: center; font-size: 13px; background: transparent; }
        .cell-input:focus { background: #fff; box-shadow: inset 0 0 0 2px var(--accent); z-index: 5; }

        .btn { padding: 6px 14px; cursor: pointer; border-radius: 4px; font-size: 12px; border: 1px solid #999; background: white; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--excel-green); color: white; border: none; }
        .btn-cloud { background: #0078d4; color: white; border: none; }
        .btn-danger { background: #d93025; color: white; border: none; }
        
        .status-bar { background: var(--excel-green); color: white; padding: 3px 15px; font-size: 11px; display: flex; justify-content: space-between; }
    </style>
</head>
<body onpaste="handlePaste(event)">

    <div id="lockScreen">
        <div class="lock-box">
            <h2 style="margin-top:0">ğŸ”’ Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…ÙŠØ©</h2>
            <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            <input type="password" id="passCode" placeholder="***">
            <button class="unlock-btn" onclick="checkPass()">ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div id="mainContainer">
        <div class="setup-bar">
            <span>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨:</span>
            <input type="password" id="ghToken" placeholder="GitHub Token">
            <input type="text" id="ghRepo" value="Mo-Ibrahim50015/royal-jazz-syste">
            <button class="btn" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø·</button>
        </div>

        <div class="ribbon">
            <button class="btn btn-primary" onclick="pullFromGitHub()">ğŸ”„ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn btn-cloud" onclick="pushToGitHub()">â˜ï¸ Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨</button>
            <div style="width:1px; background:#ccc; margin:0 5px"></div>
            <button class="btn" onclick="addNewRow()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
            <button class="btn" onclick="addColumn()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
            <button class="btn btn-danger" onclick="deleteSelectedItems()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (ØµÙÙˆÙ/Ø£Ø¹Ù…Ø¯Ø©)</button>
            <button class="btn" onclick="clearSelection()">ğŸ§¹ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
            <button class="btn" style="background:#f39c12; color:white; border:none" onclick="undo()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
        </div>

        <div class="grid-container">
            <table id="excelTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="status-bar">
            <span id="statusMsg">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªØµÙ„</span>
            <span>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙÙˆÙ Ø£Ùˆ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯Ù‡Ø§</span>
        </div>
    </div>

    <script>
        let dbData = [];
        let history = [];
        let selectedRows = new Set();
        let selectedCols = new Set();
        const fileName = "database.xlsx";

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ---
        function checkPass() {
            const input = document.getElementById('passCode').value;
            const standardInput = input.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
            if (standardInput === "444") {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('mainContainer').style.visibility = 'visible';
                loadSettings();
            } else { alert("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø®Ø·Ø£!"); }
        }

        // --- Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ---
        function toggleRowSelection(idx) {
            if (selectedRows.has(idx)) selectedRows.delete(idx);
            else selectedRows.add(idx);
            renderTable();
        }

        function toggleColSelection(idx) {
            if (selectedCols.has(idx)) selectedCols.delete(idx);
            else selectedCols.add(idx);
            renderTable();
        }

        function clearSelection() {
            selectedRows.clear();
            selectedCols.clear();
            renderTable();
        }

        function deleteSelectedItems() {
            if (selectedRows.size === 0 && selectedCols.size === 0) return alert("Ø¨Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØµÙÙˆÙ Ø£Ùˆ Ø£Ø¹Ù…Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹");
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ")) return;

            saveHistory();
            
            // Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ù„Ù„Ø£ØµØºØ± Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨)
            const sortedCols = Array.from(selectedCols).sort((a, b) => b - a);
            sortedCols.forEach(cIdx => {
                dbData.forEach(row => row.splice(cIdx, 1));
            });

            // Ø­Ø°Ù Ø§Ù„ØµÙÙˆÙ (Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ù„Ù„Ø£ØµØºØ±)
            const sortedRows = Array.from(selectedRows).sort((a, b) => b - a);
            sortedRows.forEach(rIdx => {
                dbData.splice(rIdx, 1);
            });

            clearSelection();
        }

        // --- Ø§Ù„Ù„ØµÙ‚ Ø§Ù„Ø°ÙƒÙŠ ---
        function handlePaste(e) {
            if (document.getElementById('lockScreen').style.display === 'none') {
                const clipboardData = e.clipboardData || window.clipboardData;
                const pastedData = clipboardData.getData('Text');
                if (!pastedData) return;
                const rows = pastedData.trim().split(/\r\n|\n|\r/).map(row => row.split('\t'));
                if (rows.length > 0) {
                    saveHistory();
                    if (dbData.length === 0 || confirm("Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) dbData = rows;
                    else {
                        const maxCols = Math.max(dbData[0].length, rows[0].length);
                        dbData.forEach(r => { while(r.length < maxCols) r.push(""); });
                        rows.forEach(r => { while(r.length < maxCols) r.push(""); dbData.push(r); });
                    }
                    renderTable();
                    e.preventDefault();
                }
            }
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ---
        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = ""; tbody.innerHTML = "";
            if (dbData.length === 0) return;

            const hTr = document.createElement('tr');
            hTr.innerHTML = `<th class="row-header" onclick="clearSelection()">#</th>`;
            dbData[0].forEach((h, i) => {
                const th = document.createElement('th');
                th.innerText = h || `Ø¹Ù…ÙˆØ¯ ${i+1}`;
                if (selectedCols.has(i)) th.className = "selected-head";
                th.onclick = () => toggleColSelection(i);
                th.ondblclick = () => renameCol(i);
                hTr.appendChild(th);
            });
            thead.appendChild(hTr);

            for (let r = 1; r < dbData.length; r++) {
                const tr = document.createElement('tr');
                if (selectedRows.has(r)) tr.className = "selected-row";
                
                const rHead = document.createElement('td');
                rHead.className = "row-header" + (selectedRows.has(r) ? " selected-head" : "");
                rHead.innerText = r;
                rHead.onclick = () => toggleRowSelection(r);
                tr.appendChild(rHead);

                dbData[r].forEach((cell, c) => {
                    const td = document.createElement('td');
                    if (selectedCols.has(c)) td.className = "selected-col";
                    td.innerHTML = `<input class="cell-input" value="${cell || ''}" onchange="updateCell(${r}, ${c}, this.value)">`;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }
        }

        function renameCol(i) {
            const name = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ù…ÙˆØ¯:", dbData[0][i]);
            if (name) { saveHistory(); dbData[0][i] = name; renderTable(); }
        }

        function updateCell(r, c, val) { saveHistory(); dbData[r][c] = val; }

        function addColumn() {
            saveHistory();
            if (dbData.length === 0) dbData = [["Ø¹Ù…ÙˆØ¯ 1"], [""]];
            else dbData.forEach(r => r.push(""));
            renderTable();
        }

        function addNewRow() {
            saveHistory();
            if (dbData.length === 0) dbData = [["Ø§Ù„Ø§Ø³Ù…"], [""]];
            else dbData.push(new Array(dbData[0].length).fill(""));
            renderTable();
        }

        // --- ÙˆØ¸Ø§Ø¦Ù GitHub ---
        async function pullFromGitHub() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('ghRepo').value;
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${fileName}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const json = await res.json();
                const content = Uint8Array.from(atob(json.content), c => c.charCodeAt(0));
                const wb = XLSX.read(content, { type: 'array' });
                dbData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                renderTable();
                alert("ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } catch (e) { alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"); }
        }

        async function pushToGitHub() {
            const token = document.getElementById('ghToken').value;
            const repo = document.getElementById('ghRepo').value;
            const ws = XLSX.utils.aoa_to_sheet(dbData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            const out = XLSX.write(wb, { type: 'base64', bookType: 'xlsx' });
            let sha = "";
            const check = await fetch(`https://api.github.com/repos/${repo}/contents/${fileName}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if (check.ok) sha = (await check.json()).sha;
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${fileName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Update", content: out, sha: sha })
            });
            if (res.ok) alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨ âœ…");
        }

        function saveHistory() { history.push(JSON.stringify(dbData)); if (history.length > 20) history.shift(); }
        function undo() { if (history.length > 0) { dbData = JSON.parse(history.pop()); renderTable(); } }
        function saveSettings() {
            localStorage.setItem('gh_token', document.getElementById('ghToken').value);
            localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!");
        }
        function loadSettings() {
            document.getElementById('ghToken').value = localStorage.getItem('gh_token') || "";
            document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || "Mo-Ibrahim50015/royal-jazz-syste";
        }
    </script>
</body>
</html>
